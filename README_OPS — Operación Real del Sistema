# README_OPS ‚Äî Operaci√≥n Real del Sistema (Producci√≥n)

> **Este documento describe C√ìMO OPERA REALMENTE el sistema en producci√≥n.**
> No sustituye el README general. Lo complementa.
> Aqu√≠ se documentan **l√≠mites, responsabilidades y flujos reales**, para evitar errores operativos.

---

## 1. Principio Rector (Molde de Hierro)

El sistema opera bajo un modelo **SSOT + Espejos JSONB**.

* **SSOT (Single Source of Truth)**: tablas relacionales en Supabase
* **Espejos**: columnas JSONB optimizadas para lectura r√°pida
* **Triggers** sincronizan SSOT ‚Üí Espejo

üëâ **Si el trigger no corre, el Admin queda ciego** (aunque los datos existan).

---

## 2. Roles y Responsabilidades (NO negociable)

| Rol                | Qu√© puede hacer                                 | Qu√© NO puede hacer                |
| ------------------ | ----------------------------------------------- | --------------------------------- |
| **Admin (UI)**     | Ver datos, editar tarifas y temporadas          | Subir im√°genes, editar multimedia |
| **Horizons (n8n)** | Escribir SSOT, subir multimedia, cargas masivas | UI, edici√≥n manual                |
| **Web**            | Leer JSONB                                      | Escribir datos                    |

---

## 3. Fuente de Verdad por Dominio

| Dominio                                | SSOT                                    | Qui√©n escribe   | Qui√©n lee   |
| -------------------------------------- | --------------------------------------- | --------------- | ----------- |
| Multimedia (galer√≠a, servicios, video) | `public.hotel_media`                    | Horizons        | Admin + Web |
| Habitaciones                           | `public.rooms`                          | Horizons        | Admin + Web |
| Servicios/Amenidades                   | `public.hotel_media (scope='services')` | Horizons        | Admin + Web |
| Video Hero                             | `public.hotel_media (scope='video')`    | Horizons        | Admin + Web |
| Tarifas                                | `public.rates`                          | Admin (puntual) | Web         |
| Temporadas                             | `public.seasons`                        | Admin           | Web         |

---

## 4. Estado REAL del Admin

### El Admin es **READ-ONLY para Multimedia**

* ‚ùå No existen componentes de upload
* ‚ùå No existen modales de edici√≥n multimedia
* ‚ùå No hay botones de guardar im√°genes

Esto es **intencional**, no un bug.

üëâ Toda multimedia se gestiona **fuera del Admin**, v√≠a Horizons.

---

## 5. Flujo REAL de Multimedia (Galer√≠a, Servicios, Video)

```
Proveedor / Carpeta / Drive
        ‚Üì
Horizons (n8n)
        ‚Üì
Supabase Storage (bucket hotel-media)
        ‚Üì
public.hotel_media   ‚Üê SSOT
        ‚Üì (triggers)
hotels_master.gallery_data / services_data / hero_video
        ‚Üì
Admin (visor) + Web
```

---

## 6. Triggers Cr√≠ticos del Sistema

| Trigger                              | Funci√≥n      | Prop√≥sito                         |
| ------------------------------------ | ------------ | --------------------------------- |
| `trigger_sync_hotel_media_to_hotels` | trigger-only | Cebar galer√≠a / servicios / video |
| `trigger_sync_rooms`                 | trigger-only | Cebar rooms_data                  |

‚ö†Ô∏è **Estas funciones NO se llaman manualmente.**
Se disparan √∫nicamente por `INSERT / UPDATE / DELETE`.

---

## 7. Recuperaci√≥n POST-ROLLBACK (Obligatorio)

Despu√©s de cualquier rollback o restore:

### 7.1 Re-cebar espejos (manual)

```sql
update public.rooms set updated_at = now();
update public.hotel_media set updated_at = now();
```

Esto dispara los triggers y **devuelve visi√≥n al Admin y Web**.

---

## 8. Tarifas y Temporadas (EXCEPCI√ìN)

### ‚úÖ Permitido en Admin

* Crear / editar temporadas
* Ajustes puntuales de tarifas

### ‚ùå No permitido en Admin

* Cargas masivas
* Tarifas multi-a√±o
* Importaciones CSV grandes

üëâ Cargas industriales ‚Üí **Horizons**

---

## 9. Errores ESPERADOS (NO son bugs)

| Error                                    | Significado          |
| ---------------------------------------- | -------------------- |
| No aparecen botones de upload            | Admin es visor       |
| JSONB vac√≠o con SSOT lleno               | Trigger no disparado |
| `function can only be called as trigger` | Funci√≥n trigger-only |

---

## 10. Regla Final de Operaci√≥n

> **Si no existe fila en SSOT, no existe dato.**
> **Si el espejo no se ceb√≥, el Admin no ve nada.**

Este documento es la **fuente de verdad operativa** para producci√≥n.

---

**Archivo:** `README_OPS.md`
**√Åmbito:** Producci√≥n / Operaciones
**Complementa:** README general del repositorio
