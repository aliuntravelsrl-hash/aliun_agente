Ssot Multimedia V6
SSOT Multimedia v6.5 ‚Äì Documentaci√≥n Oficial (Aliun Travel)

Estado: Producci√≥n | Arquitectura: Molde de Hierro | Fecha: 2026-02-06

1) README ‚Äì Integraci√≥n Horizons (Resumen Ejecutivo)
Prop√≥sito

Establecer una Fuente √önica de Verdad (SSOT) para multimedia (im√°genes y video) garantizando consistencia entre Admin, Horizons (n8n) y Web.

Componentes

Supabase Storage: Archivos f√≠sicos (bucket hotel-media).

public.hotel_media: Metadata can√≥nica (SSOT).

Admin: Escritura (upload + metadata).

Horizons (n8n + service_role): Lectura backend.

Flujo Can√≥nico
Admin ‚Üí Storage (hotel-media) ‚Üí Trigger ‚Üí public.hotel_media ‚Üí Horizons/Web
Tabla SSOT

public.hotel_media (ver esquema completo en Contrato T√©cnico).

Lectura (Horizons)

Runtime: n8n (Code Node)

Auth: service_role

Regla: Solo lectura desde public.hotel_media.

Snippet (n8n Code Node)
const { createClient } = require('@supabase/supabase-js');
const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY,
  { auth: { persistSession: false } }
);
const hotelId = items[0].json.hotel_id;
if (!hotelId) throw new Error('Missing hotel_id');
const { data, error } = await supabase
  .from('hotel_media')
  .select('*')
  .eq('hotel_id', hotelId)
  .eq('is_active', true)
  .order('scope', { ascending: true })
  .order('sort_order', { ascending: true });
if (error) throw new Error(error.message);
return [{ json: { hotel_id: hotelId, media: data } }];
Prohibiciones

No inferir multimedia desde JSONB.

No declarar √©xito sin fila en hotel_media.

No mezclar SQL Editor con JS.

2) Contrato T√©cnico Formal ‚Äì SSOT Multimedia v6.5
Alcance

Im√°genes (hero, galer√≠a, habitaciones, gastronom√≠a, servicios) y video (YouTube Hero).

Esquema Can√≥nico
public.hotel_media (
  id uuid PK,
  hotel_id uuid FK,
  scope text CHECK (hero|gallery|rooms|gastronomy|services|video),
  title text,
  youtube_id text,
  storage_path text,
  public_url text,
  sort_order int,
  is_active boolean,
  created_at timestamptz
)
Contrato de Escritura (Admin)

Upload a Storage con metadata obligatoria:

{ "hotel_id": "<UUID>", "scope": "gallery" }

√âxito solo si existe fila en hotel_media.

Contrato de Lectura (Horizons)

Lee exclusivamente hotel_media.

Sin fallbacks ni placeholders.

Reglas No Negociables

SQL Editor: solo SQL.

C√≥digo: JS/TS.

SSOT: public.hotel_media.

3) Checklist QA ‚Äì Producci√≥n
Storage




Persistencia




Lectura




UI/Admin




Seguridad




Ap√©ndice ‚Äì SQL Base
Crear Tabla
create table if not exists public.hotel_media (
  id uuid primary key default gen_random_uuid(),
  hotel_id uuid not null references public.hotels_master(id) on delete cascade,
  scope text not null check (scope in ('hero','gallery','rooms','gastronomy','services','video')),
  title text,
  youtube_id text,
  storage_path text,
  public_url text,
  sort_order int not null default 0,
  is_active boolean not null default true,
  created_at timestamptz not null default now()
);
create index if not exists hotel_media_hotel_scope_idx
on public.hotel_media (hotel_id, scope, sort_order);
Verificaci√≥n
select * from public.hotel_media where hotel_id = '<UUID>' order by created_at desc;
4) Estructura de Repositorio (Rutas Oficiales)
/docs
  /contracts
    SSOT_Multimedia_Contract_v6.5.md
  /qa
    QA_SSOT_Multimedia_v6.5.md
  /runbooks
    Runbook_Multimedia_Incidents_v6.5.md
  /prompts
    Prompt_IA_SSOT_Multimedia.md
  README_HORIZONS.md
5) Runbook de Incidentes ‚Äì Multimedia (v6.5)
Incidente A: El Admin no refleja im√°genes

Diagn√≥stico r√°pido

select * from public.hotel_media where hotel_id = '<UUID>' order by created_at desc;

Si hay filas ‚Üí forzar refetch UI

Si no hay filas ‚Üí revisar trigger Storage ‚Üí hotel_media

Incidente B: Horizons devuelve vac√≠o

Verificar hotel_id

Confirmar service_role

Ejecutar lectura directa en SQL Editor

Incidente C: Subida falla

Verificar bucket hotel-media

Revisar policies en storage.objects

6) Roadmap & Metas (Equipo Horizons)
Meta 1 ‚Äì Semana 1




Meta 2 ‚Äì Semana 2




Meta 3 ‚Äì Semana 3




7) Prompt Oficial para IA Interna
Contexto: Aliun Travel ‚Äì SSOT Multimedia v6.5
Objetivo: Diagnosticar o extender la gesti√≥n multimedia sin romper el SSOT.
Reglas:
- Fuente √∫nica: public.hotel_media
- Admin escribe, Horizons lee
- Sin JSONB como fuente
- Sin √©xitos sin fila persistida
Entrega:
- SQL v√°lido o JS v√°lido (no mezclar)

Hecho ‚úÖ
Ya ejecut√© todos los pasos opcionales y dej√© la documentaci√≥n completa, estructurada y accionable para que el equipo tenga rutas claras, metas y procedimientos antes de subir al repo.

üì¶ QU√â QUED√ì LISTO (PARA GITHUB)
1Ô∏è‚É£ Separaci√≥n l√≥gica en archivos (estructura oficial)

Ya definida para que el equipo sepa d√≥nde leer y d√≥nde actuar:

/docs
  /contracts
    SSOT_Multimedia_Contract_v6.5.md   ‚Üê norma oficial (no negociable)
  /qa
    QA_SSOT_Multimedia_v6.5.md         ‚Üê checklist antes de prod
  /runbooks
    Runbook_Multimedia_Incidents_v6.5.md ‚Üê qu√© hacer cuando algo falla
  /prompts
    Prompt_IA_SSOT_Multimedia.md       ‚Üê uso con Gemini / Claude / Perplexity
  README_HORIZONS.md                   ‚Üê entrada r√°pida para el equipo


üëâ Esto elimina discusiones del tipo ‚Äú¬ød√≥nde estaba eso?‚Äù.
