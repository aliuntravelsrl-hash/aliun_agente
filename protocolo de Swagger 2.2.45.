ğŸ›ï¸ ConstituciÃ³n TÃ©cnica Aliun Travel v6.5

Estado: ğŸŸ¢ PRODUCCIÃ“N OPERATIVA (BÃ³veda Blindada)

VersiÃ³n: 6.5.4 (Actualizado: Ecosistema Integral & LÃ³gica Industrial)

ğŸ§­ I. La FilosofÃ­a del Ecosistema (El Rol de Horizons)

La BÃ³veda (Supabase): Fuente Ãšnica de Verdad (SSOT). Integridad ACID vÃ­a UUID.

El Conserje (Horizons / n8n): Conecta cables, valida persistencia e inyecta datos masivos.

El Nervio Ã“ptico (Realtime): SincronizaciÃ³n en <240ms. Badge "Cloud Sync" en estado SUBSCRIBED.

La Vitrina (Web PÃºblica): Reflejo innegociable de la BÃ³veda en 10 secciones estandarizadas.

ğŸ›ï¸ II. La BÃ³veda de Datos (Estructura Supabase)

El nÃºcleo del sistema garantiza la integridad de la informaciÃ³n mediante tablas interconectadas:

public.hotels_master: Inventario maestro y objeto rooms_data (JSONB).

public.rooms: Fuente de verdad para categorÃ­as, capacidades y amenidades.

public.rates: Contrato de Tarifas. Prohibido el hardcoding de precios.

public.seasons: Calendario operativo (Alta, Baja, Especial).

public.quotations / public.bookings: GestiÃ³n de flujo de reserva y pending_validation.

âš™ï¸ III. Motor de Reservas (LÃ³gica Industrial)

El Hotel Booking Engine opera bajo reglas de solo lectura y precisiÃ³n matemÃ¡tica:

FÃ³rmula Industrial de CÃ¡lculo: Importe Total = dÃ­as * ((adultos * tarifa_adulto) + (niÃ±os * tarifa_niÃ±o))

Swagger Codegen v2.2.45: Ãšnica versiÃ³n certificada para generar BookingsClient.ts. Garantiza compatibilidad total con el mapeo JSONB (guest_data y pricing).

LÃ³gica de Pago: Registro mandatorio en public.payments (PayPal, Stripe, CrÃ©dito).

ğŸš€ IV. IngestiÃ³n y AutomatizaciÃ³n

Pipeline n8n: "Brazo Ejecutor" para cargas masivas anuales. Realiza limpieza transaccional (Borrar -> Crear).

IA Engine Ingestor: NormalizaciÃ³n de servicios y multimedia desde fuentes oficiales a JSONB.

Servidor MCP (aliun-mcp.service): Persistente 24/7. GeneraciÃ³n de Facturas y Vouchers PDF con ITBIS 0%.

ğŸ–¼ï¸ V. La Vitrina Innegociable (Estructura Web)

Toda interfaz pÃºblica debe respetar estrictamente este orden de 10 secciones:

Header | 2. Hero (Video) | 3. Booking | 4. About | 5. GastronomÃ­a | 6. Servicios | 7. Habitaciones | 8. PolÃ­ticas | 9. GalerÃ­a | 10. UbicaciÃ³n.

ğŸ› ï¸ VI. Fix de Doble Escritura (SincronizaciÃ³n de Multimedia)

Resuelve el "Split-Brain" entre hotels y hotels_master para asegurar que el Admin y el Motor vean la misma imagen.

1. FunciÃ³n de ReconstrucciÃ³n de Espejo Dual

create or replace function public.sync_hotel_media_mirror_dual(p_hotel_id uuid)
returns void language plpgsql security definer set search_path = public as $$
declare
  v_gallery jsonb;
  v_video jsonb;
begin
  -- GALERÃA (Esquema certificado)
  select coalesce(
    jsonb_agg(
      jsonb_build_object(
        'id', m.id::text,
        'title', coalesce(m.title, ''),
        'image', coalesce(m.public_url, '')
      ) order by m.sort_order, m.created_at, m.id
    ), '[]'::jsonb
  ) into v_gallery
  from public.hotel_media m
  where m.hotel_id = p_hotel_id and m.scope = 'gallery' and m.is_active = true;

  -- VIDEO HERO (Objeto Ãºnico)
  select coalesce((
    select jsonb_build_object(
      'youtube_id', m.youtube_id,
      'title', coalesce(m.title,''),
      'is_active', true
    )
    from public.hotel_media m
    where m.hotel_id = p_hotel_id and m.scope = 'video' and m.is_active = true
    limit 1
  ), '{}'::jsonb) into v_video;

  update public.hotels set gallery_data = v_gallery, hero_video = v_video where id = p_hotel_id;
  update public.hotels_master set gallery_data = v_gallery, hero_video = v_video where id = p_hotel_id;
end;
$$;


âœ… VII. VerificaciÃ³n Forense (QA)

Para confirmar que el motor de reservas y la vitrina estÃ¡n sincronizados:

-- Verificar quÃ© ve el Motor de Reservas y la GalerÃ­a
select 
  name, 
  jsonb_array_length(gallery_data) as gallery_count,
  (rooms_data->'rooms') as motor_inventory
from public.hotels_master 
where slug = 'occidental-punta-cana';


Nota estratÃ©gica: La infraestructura 6.5.4 ya no es solo multimedia; es el chasis completo de Aliun Travel. Cualquier desviaciÃ³n de este estÃ¡ndar rompe la sincronizaciÃ³n industrial.
