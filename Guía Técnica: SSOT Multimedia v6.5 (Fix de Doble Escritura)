üèõÔ∏è Gu√≠a T√©cnica: SSOT Multimedia v6.5 (Fix de Doble Escritura)

Estado: üü¢ PRODUCCI√ìN OPERATIVA

Versi√≥n: 6.5.1

Objetivo: Resolver el "Split-Brain" entre public.hotels y public.hotels_master mediante una arquitectura de Espejo Dual.

üîç I. Protocolo de Diagn√≥stico de B√≥veda

Antes de cualquier intervenci√≥n, debemos identificar d√≥nde est√° leyendo el Admin y d√≥nde estamos escribiendo nosotros.

‚úÖ Prueba 1: Localizaci√≥n de Identidad

Determina si el hotel existe en una o ambas tablas core.

select 'hotels' as src, id, slug from public.hotels where id = '709aba58-ec3e-4840-80a3-b801ea7dc736'
union all
select 'hotels_master' as src, id, slug from public.hotels_master where id = '709aba58-ec3e-4840-80a3-b801ea7dc736';


Solo hotels: El Admin consume la tabla legacy.

Solo hotels_master: El Admin consume la nueva b√≥veda.

Ambas: Hay duplicidad de fuente (Riesgo de desincronizaci√≥n).

‚úÖ Prueba 2: Verificaci√≥n de Columnas Espejo

select table_name, column_name, data_type 
from information_schema.columnswhere table_schema='public'
  and table_name in ('hotels','hotels_master')
  and column_name in ('gallery_data','hero_video') 
order by table_name, column_name;


‚úÖ Prueba 3: Test de Realtime

Sube una imagen o haz un UPDATE manual y verifica cu√°l tabla refleja el cambio en el updated_at o en el contenido del JSONB.

üõ†Ô∏è II. Implementaci√≥n del Fix: Espejo en Dual-Mode

Si detectamos que el sistema lee de ambas tablas o hay ambig√ºedad, aplicamos el Modo Compatibilidad para cerrar el incidente de inmediato.

1. Asegurar Columnas Espejo en ambas tablas

alter table public.hotels
  add column if not exists gallery_data jsonb not null default '[]'::jsonb,
  add column if not exists hero_video jsonb not null default '{}'::jsonb;

alter table public.hotels_master
  add column if not exists gallery_data jsonb not null default '[]'::jsonb,
  add column if not exists hero_video jsonb not null default '{}'::jsonb;


2. Funci√≥n de Reconstrucci√≥n de Espejo (Doble Escritura)

Esta funci√≥n lee de la SSOT (hotel_media) y escribe el JSONB procesado en ambas tablas core.

create or replace function public.sync_hotel_media_mirror_dual(p_hotel_id uuid)
returns void language plpgsql security definer set search_path = public as $$
declare
  v_gallery jsonb;
  v_video jsonb;
begin
  -- GALER√çA (Esquema certificado para el Frontend)
  select coalesce(
    jsonb_agg(
      jsonb_build_object(
        'id', m.id::text,
        'title', coalesce(m.title, ''),
        'image', coalesce(m.public_url, '')
      ) order by m.sort_order, m.created_at, m.id
    ), '[]'::jsonb
  ) into v_gallery
  from public.hotel_media m
  where m.hotel_id = p_hotel_id and m.scope = 'gallery' and m.is_active = true;

  -- VIDEO HERO (Objeto √∫nico para el Header)
  select coalesce((
    select jsonb_build_object(
      'youtube_id', m.youtube_id,
      'title', coalesce(m.title,''),
      'is_active', true
    )
    from public.hotel_media m
    where m.hotel_id = p_hotel_id and m.scope = 'video' and m.is_active = true
    limit 1
  ), '{}'::jsonb) into v_video;

  -- EJECUCI√ìN DEL ESPEJO DUAL
  update public.hotels set gallery_data = v_gallery, hero_video = v_video where id = p_hotel_id;
  update public.hotels_master set gallery_data = v_gallery, hero_video = v_video where id = p_hotel_id;
end;
$$;


3. Trigger de Activaci√≥n Autom√°tica

Cualquier cambio en la tabla SSOT dispara la actualizaci√≥n de los espejos JSONB.

create or replace function public.trg_sync_hotel_media_mirror_dual()
returns trigger language plpgsql security definer set search_path = public as $$
begin
  perform public.sync_hotel_media_mirror_dual(coalesce(new.hotel_id, old.hotel_id));
  return coalesce(new, old);
end;
$$;

drop trigger if exists trigger_sync_hotel_media_to_hotels on public.hotel_media;
create trigger trigger_sync_hotel_media_to_hotels
after insert or update or delete on public.hotel_media
for each row execute function public.trg_sync_hotel_media_mirror_dual();


üì° III. Protocolo Operativo Horizons (n8n)

Fase 1: Activaci√≥n de Galer√≠a

Regla: Imagen activa solo si existe en hotel_media, scope='gallery', is_active=true y tiene URL.

Acci√≥n de Horizons: Solo inserta en hotel_media. El trigger hace el resto.

Validaci√≥n: select count(*) > 0 from public.hotel_media where hotel_id = $1 and scope = 'gallery';

Fase 2: Activaci√≥n de Video Hero

Regla: Solo si existe youtube_id.

Inserci√≥n: ```sql
insert into public.hotel_media (hotel_id, scope, youtube_id, is_active)
values ($1, 'video', $2, true);




Fase 3: Lectura oficial del Admin

El Admin NO consulta la tabla de media directamente. Debe leer de hotels.gallery_data para aprovechar la velocidad del JSONB y el Realtime.

‚úÖ IV. Verificaci√≥n Final (QA)

Ejecutar para confirmar que ambas tablas est√°n en perfecta sincron√≠a:

select 'hotels' src, id, jsonb_array_length(gallery_data) as gallery_len, hero_video 
from public.hotels where id = '709aba58-ec3e-4840-80a3-b801ea7dc736'
union all
select 'hotels_master' src, id, jsonb_array_length(gallery_data), hero_video 
from public.hotels_master where id = '709aba58-ec3e-4840-80a3-b801ea7dc736';


Nota estrat√©gica: Este modo de doble escritura es una medida de contingencia para evitar el tiempo de inactividad mientras se consolida la UI hacia una sola tabla core.
