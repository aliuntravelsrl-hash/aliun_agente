ğŸ›ï¸ ConstituciÃ³n TÃ©cnica Aliun Travel v6.5

Estado: ğŸŸ¢ PRODUCCIÃ“N OPERATIVA (BÃ³veda Blindada)

VersiÃ³n: 6.5.5 (Actualizado: ConexiÃ³n de Servicios & Estructura de PÃ¡gina)

ğŸ§­ I. La FilosofÃ­a del Ecosistema (El Rol de Horizons)

La BÃ³veda (Supabase): Fuente Ãšnica de Verdad (SSOT). Integridad ACID vÃ­a UUID.

El Conserje (Horizons / n8n): Conecta cables, valida persistencia e inyecta datos masivos.

El Nervio Ã“ptico (Realtime): SincronizaciÃ³n en <240ms. Badge "Cloud Sync" en estado SUBSCRIBED.

La Vitrina (Web PÃºblica): Reflejo innegociable de la BÃ³veda en 10 secciones estandarizadas.

ğŸ› ï¸ II. Fix de Doble Escritura (SincronizaciÃ³n de Multimedia y Servicios)

Resuelve el "Split-Brain" asegurando que el Admin y la Web vean los mismos datos de GalerÃ­a, Video y Servicios.

1. Asegurar Columnas Espejo (Incluye Services)

alter table public.hotels
  add column if not exists gallery_data jsonb not null default '[]'::jsonb,
  add column if not exists hero_video jsonb not null default '{}'::jsonb,
  add column if not exists services_data jsonb not null default '[]'::jsonb;

alter table public.hotels_master
  add column if not exists gallery_data jsonb not null default '[]'::jsonb,
  add column if not exists hero_video jsonb not null default '{}'::jsonb,
  add column if not exists services_data jsonb not null default '[]'::jsonb;


2. FunciÃ³n de ReconstrucciÃ³n de Espejo Dual (v6.5.5)

create or replace function public.sync_hotel_media_mirror_dual(p_hotel_id uuid)
returns void language plpgsql security definer set search_path = public as $$
declare
  v_gallery jsonb;
  v_video jsonb;
  v_services jsonb;
begin
  -- 1. GALERÃA
  select coalesce(jsonb_agg(jsonb_build_object(
    'id', m.id::text, 'title', coalesce(m.title, ''), 'image', coalesce(m.public_url, '')
  ) order by m.sort_order, m.created_at), '[]'::jsonb) into v_gallery
  from public.hotel_media m where m.hotel_id = p_hotel_id and m.scope = 'gallery' and m.is_active = true;

  -- 2. VIDEO HERO
  select coalesce((select jsonb_build_object(
    'youtube_id', m.youtube_id, 'title', coalesce(m.title,''), 'is_active', true
  ) from public.hotel_media m where m.hotel_id = p_hotel_id and m.scope = 'video' and m.is_active = true limit 1), '{}'::jsonb) into v_video;

  -- 3. SERVICIOS (Nuevo Espejo)
  select coalesce(jsonb_agg(jsonb_build_object(
    'title', m.title, 'icon', coalesce(m.public_url, ''), 'is_active', true
  ) order by m.sort_order), '[]'::jsonb) into v_services
  from public.hotel_media m where m.hotel_id = p_hotel_id and m.scope = 'services' and m.is_active = true;

  -- ACTUALIZACIÃ“N DUAL
  update public.hotels set gallery_data = v_gallery, hero_video = v_video, services_data = v_services where id = p_hotel_id;
  update public.hotels_master set gallery_data = v_gallery, hero_video = v_video, services_data = v_services where id = p_hotel_id;
end;
$$;


ğŸ“¡ VIII. Protocolo Horizons (n8n): ConexiÃ³n de Servicios

1. ResoluciÃ³n de Identidad por Slug

Horizons debe obtener el hotel_id canÃ³nico antes de cualquier operaciÃ³n:

// n8n Code Node
const slug = items[0].json.slug;
let { data: hm } = await supabase.from('hotels_master').select('id').eq('slug', slug).single();
if (!hm) {
  let { data: h } = await supabase.from('hotels').select('id').eq('slug', slug).single();
  hm = h;
}
items[0].json.hotel_id = hm.id;


2. ActivaciÃ³n de SecciÃ³n en page_structure

La secciÃ³n Services solo es visible si estÃ¡ habilitada en el JSONB de estructura:

update public.hotels_master 
set page_structure = jsonb_set(
  page_structure, 
  '{sections}', 
  (
    select jsonb_agg(
      case when value->>'id' = 'services' 
      then value || '{"enabled": true}'::jsonb 
      else value end
    )
    from jsonb_array_elements(page_structure->'sections')
  )
)
where id = 'UUID_DEL_HOTEL';


3. InyecciÃ³n en SSOT (hotel_media)

Horizons inyecta las amenidades con scope='services'. El trigger automÃ¡tico actualizarÃ¡ el espejo services_data.

const payload = [
  { hotel_id: hotelId, scope: 'services', title: 'Wi-Fi Gratis', public_url: '[https://cdn.aliun.travel/icons/wifi.svg](https://cdn.aliun.travel/icons/wifi.svg)', sort_order: 1 },
  { hotel_id: hotelId, scope: 'services', title: 'Piscina Infinity', public_url: '[https://cdn.aliun.travel/icons/pool.svg](https://cdn.aliun.travel/icons/pool.svg)', sort_order: 2 }
];
await supabase.from('hotel_media').insert(payload);


4. VerificaciÃ³n de Ã‰xito (Anti-Fantasma)

Horizons solo reporta SUCCESS si:

page_structure tiene services.enabled = true.

public.hotel_media tiene al menos 1 registro activo de tipo services.

âœ… VII. VerificaciÃ³n Forense (QA)

select 
  name, 
  (page_structure->'sections') @> '[{"id": "services", "enabled": true}]' as section_ready,
  jsonb_array_length(services_data) as services_count
from public.hotels_master 
where slug = 'bahia-principe-fantasia-punta-cana';


Firmado: AuditorÃ­a de Sistemas Aliun Travel v6.5.5
