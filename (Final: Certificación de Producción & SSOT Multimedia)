ğŸ›ï¸ ConstituciÃ³n TÃ©cnica Aliun Travel v6.5

Estado: ğŸŸ¢ PRODUCCIÃ“N OPERATIVA (BÃ³veda Blindada)

VersiÃ³n: 6.5.6 (Final: CertificaciÃ³n de ProducciÃ³n & SSOT Multimedia)

ğŸ§­ I. La FilosofÃ­a del Ecosistema (El Rol de Horizons)

La BÃ³veda (Supabase): Fuente Ãšnica de Verdad (SSOT). Integridad ACID vÃ­a UUID.

El Conserje (Horizons / n8n): Conecta cables, valida persistencia e inyecta datos masivos.

El Nervio Ã“ptico (Realtime): SincronizaciÃ³n en <240ms. Badge "Cloud Sync" en estado SUBSCRIBED.

La Vitrina (Web PÃºblica): Reflejo innegociable de la BÃ³veda en 10 secciones estandarizadas.

ğŸ›ï¸ II. La BÃ³veda de Datos (Estructura Supabase)

El nÃºcleo del sistema garantiza la integridad de la informaciÃ³n mediante tablas interconectadas:

public.hotels_master: Inventario maestro y objeto rooms_data (JSONB).

public.rooms: Fuente de verdad para categorÃ­as, capacidades y amenidades.

public.rates: Contrato de Tarifas. Prohibido el hardcoding de precios.

public.seasons: Calendario operativo (Alta, Baja, Especial).

public.quotations / public.bookings: GestiÃ³n de flujo de reserva y pending_validation.

âš™ï¸ III. Motor de Reservas (LÃ³gica Industrial)

El Hotel Booking Engine opera bajo reglas de solo lectura y precisiÃ³n matemÃ¡tica:

FÃ³rmula Industrial de CÃ¡lculo: Importe Total = dÃ­as * ((adultos * tarifa_adulto) + (niÃ±os * tarifa_niÃ±o))

Swagger Codegen v2.2.45: Ãšnica versiÃ³n certificada para generar BookingsClient.ts. Garantiza compatibilidad total con el mapeo JSONB (guest_data y pricing).

LÃ³gica de Pago: Registro mandatorio en public.payments (PayPal, Stripe, CrÃ©dito).

ğŸš€ IV. IngestiÃ³n y AutomatizaciÃ³n

Pipeline n8n: "Brazo Ejecutor" para cargas masivas anuales. Realiza limpieza transaccional (Borrar -> Crear).

IA Engine Ingestor: NormalizaciÃ³n de servicios y multimedia desde fuentes oficiales a JSONB.

Servidor MCP (aliun-mcp.service): Persistente 24/7. GeneraciÃ³n de Facturas y Vouchers PDF con ITBIS 0%.

ğŸ–¼ï¸ V. La Vitrina Innegociable (Estructura Web)

Toda interfaz pÃºblica debe respetar estrictamente este orden de 10 secciones:

Header | 2. Hero (Video) | 3. Booking | 4. About | 5. GastronomÃ­a | 6. Servicios | 7. Habitaciones | 8. PolÃ­ticas | 9. GalerÃ­a | 10. UbicaciÃ³n.

ğŸ› ï¸ VI. Fix de Doble Escritura (SincronizaciÃ³n de Multimedia y Servicios)

Resuelve el "Split-Brain" asegurando que el Admin y la Web vean los mismos datos de GalerÃ­a, Video y Servicios.

1. FunciÃ³n de ReconstrucciÃ³n de Espejo Dual

create or replace function public.sync_hotel_media_mirror_dual(p_hotel_id uuid)
returns void language plpgsql security definer set search_path = public as $$
declare
  v_gallery jsonb;
  v_video jsonb;
  v_services jsonb;
begin
  -- 1. GALERÃA
  select coalesce(jsonb_agg(jsonb_build_object(
    'id', m.id::text, 'title', coalesce(m.title, ''), 'image', coalesce(m.public_url, '')
  ) order by m.sort_order, m.created_at), '[]'::jsonb) into v_gallery
  from public.hotel_media m where m.hotel_id = p_hotel_id and m.scope = 'gallery' and m.is_active = true;

  -- 2. VIDEO HERO
  select coalesce((select jsonb_build_object(
    'youtube_id', m.youtube_id, 'title', coalesce(m.title,''), 'is_active', true
  ) from public.hotel_media m where m.hotel_id = p_hotel_id and m.scope = 'video' and m.is_active = true limit 1), '{}'::jsonb) into v_video;

  -- 3. SERVICIOS
  select coalesce(jsonb_agg(jsonb_build_object(
    'title', m.title, 'icon', coalesce(m.public_url, ''), 'is_active', true
  ) order by m.sort_order), '[]'::jsonb) into v_services
  from public.hotel_media m where m.hotel_id = p_hotel_id and m.scope = 'services' and m.is_active = true;

  update public.hotels set gallery_data = v_gallery, hero_video = v_video, services_data = v_services where id = p_hotel_id;
  update public.hotels_master set gallery_data = v_gallery, hero_video = v_video, services_data = v_services where id = p_hotel_id;
end;
$$;


ğŸ“¡ VII. Protocolo Horizons (n8n): ConexiÃ³n de Servicios

ResoluciÃ³n de Identidad: Obtener hotel_id por slug en hotels_master.

ActivaciÃ³n de SecciÃ³n: Habilitar services en page_structure.

InyecciÃ³n en SSOT: Insertar en hotel_media con scope='services'.

VerificaciÃ³n: Validar persistencia fÃ­sica antes de reportar SUCCESS.

âœ… VIII. VerificaciÃ³n Forense (QA)

Para confirmar que el motor de reservas y la vitrina estÃ¡n sincronizados:

select 
  name, 
  (page_structure->'sections') @> '[{"id": "services", "enabled": true}]' as section_ready,
  jsonb_array_length(gallery_data) as gallery_count,
  (rooms_data->'rooms') as motor_inventory
from public.hotels_master 
where slug = 'occidental-punta-cana';


âœ¨ IX. ConclusiÃ³n y Estado Final

La arquitectura SSOT Multimedia v6.5.1 estÃ¡ completamente validada y operativa.

âœ… Protocolo de DiagnÃ³stico: Todas las pruebas tÃ©cnicas y forenses han sido superadas.

âœ… SincronizaciÃ³n Dual: EliminaciÃ³n del "Split-Brain" entre tablas core (hotels vs hotels_master).

âœ… Triggers AutomÃ¡ticos: SincronizaciÃ³n reactiva del Storage a la BÃ³veda activa y funcional.

âœ… AuditorÃ­a Completa: Registro transaccional de cada cambio en la multimedia y servicios.

âœ… Dashboard Multimedia: GestiÃ³n en tiempo real operativa en el Admin.

âœ… Protocolo Operativo: Documentado para el equipo de IngenierÃ­a y Horizons.

El sistema estÃ¡ completamente listo para producciÃ³n. ğŸš€

Firmado: AuditorÃ­a de Sistemas Aliun Travel v6.5.6

Verdad Industrial Garantizada
